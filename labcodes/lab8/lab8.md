# Lab7 实验报告

## 实验涉及知识点

- 文件系统的整体框架结构：FS系统调用接口、VFS、SFS、IO接口
- 磁盘中文件的组织方式（索引访问）
- ucore中抽象文件系统VFS和具体文件系统SFS的主要数据结构的实现
- I/O设备的管理方法

## OS原理中很重要，但实验中未出现的知识点

- 网络、分布式文件系统
- 冗余磁盘阵列RAID

## 练习1：完成读文件操作的实现

*【设计实现】*

练习1需要补全`sfs_inode.c`中的`sfs_io_nolock`函数，其主要功能是完成指定区段的、内存buffer与磁盘块（disk blocks）之间的读写。

- 在练习1的代码之前，此函数已经通过重重判断，确定了读写的终止位置`endpos`，而起始位置是函数的参数`offset`。`offset`和`endpos`都是相对于内存中的文件（file）而言的偏移。
- 由`offset`确定内存文件数据块的编号`blkno = offset / SFS_BLKSIZE `。
- 通过调用关键函数`sfs_bmap_load_nolock(sfs, sin, blkno, &ino)`找到当前偏移`offset`对应的磁盘块的序号`ino`，建立起内存数据块与磁盘块的映射。
- 调用`sfs_buf_op(sfs, buf, size, ino, blkoff)`完成长度为`size`的、内存`buf`与磁盘块`ino`之间的读或写操作。

整个读写过程分为三小步：

- 开头（可能）不完整的一个block的读写；
- 中间完整的若干个block的读写；
- 结尾（可能）不完整的一个block的读写。

采用上述方法和步骤，并作即时的结束判断，便可实现文件的I/O操作了。

### 1.1 请给出设计实现”UNIX的PIPE机制“的概要设方案，鼓励给出详细设计方案。
#### 管道机制简述

PIPE（管道）机制是UNIX下的进程通讯机制之一，一般可用于具有亲缘关系进程间的通信。

管道实际上是个只存在于内存中的文件，对这个文件的操作要通过两个已经打开文件进行，它们分别代表管道的两端。它是一种特殊的文件，它不属于某一种文件系统，而是一种独立的文件系统，有其自己的数据结构。

事实上，位于管道两端的文件，一个只负责往管道写数据，一个只负责从管道读数据，这等价于OS原理课上讲的**生产者-消费者问题**。

#### 实现方案

由于PIPE是一个特殊的文件，那么我们就需要在VFS层面定义好相应的数据结构，并实现它的open、close、read、write等基本函数。

同时，由于同步互斥问题的存在，在实现这些函数的过程中需要注意同步互斥的控制。

## 练习2完成基于文件系统的执行程序机制的实现

*【设计实现】*

练习2主要实现`load_icode()`函数，其功能是执行存储在文件中的用户程序。

主要流程与lab7的`load_icode()`一致，不同之处在于：

- 使用读文件的方法，基于文件系统从硬盘读入程序内容到内存中。lab7及其之前则是直接由bootloader加载相应程序到内存中。
- 需要处理用户栈中传入的参数（`argc`、`argv`）。

读文件主要用到了`load_icode_read()`函数，它根据`fd`（当前文件在打开文件列表`fd_array`中的index）来找到当前文件，并根据`len`、`offset`两个参数，完成磁盘与内存中缓冲区`buf`之间的读写操作（这里就通过层层调用，用到了练习1中的读写操作函数）。

在加载程序到内存的时候，先读取elf文件头`elfhdr`，再根据文件头的信息，循环读取每个程序段的头部`proghdr`，逐步完成加载。

用户进程传入的参数`argc`、`argv`将被存到用户栈的栈顶上，共用户程序访问使用。

### 2.1 请给出设计实现基于”UNIX的硬链接和软链接机制“的概要设方案，鼓励给出详细设计方案。
OS原理中的相关描述：

- 硬链接：多个文件项指向一个文件。
- 软链接：以“快捷方式”指向其他文件（通过存储真实文件的逻辑名称来实现）。

据此，可设计如下实现方案：

- 硬链接的设计：使每个硬链接对应一个目录，对应的编号就是被链接文件的数据块索引值。
- 软链接的设计：使每个软链接对应一个新的索引节点（`sturct inode`），对应的数据块储存着被链接文件的绝对路径。